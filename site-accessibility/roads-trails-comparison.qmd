---
author: "Anna Ramji"
---

Comparing roads and trails data from USGS and Los Padres National Parks


```{r setup}
library(tidyverse)
library(here)
library(janitor)

library(sf)
library(ggspatial)
library(terra)
library(leaflet)
library(stars)
library(gdistance)
```

```{r data}
# read in data

# ------ LPNF boundary shapefiles ---------
# Southern region
lpnf_boundary_south <- st_read(here("~/../../capstone/milkweedmod/data/lpnf_boundary_data/lpnf_boundary_south/lpnf_boundary_south.shp"))

# Northern region 
lpnf_boundary_north <- st_read(here("~/../../capstone/milkweedmod/data/lpnf_boundary_data/lpnf_boundary_north/lpnf_boundary_north.shp")) %>% 
  janitor::clean_names() %>% 
  mutate(region = "North") %>% 
  dplyr::select(region, geometry)
  


# ------ Trails & Roads shapefile ----------------
# read in LPNF trails data 
trails_and_roads <- st_read(here("~/../../capstone/milkweedmod/data/2023_Regional_Trails_and_Roads_lines/2023_Regional_Trails_and_Roads_lines.shp"))

usgs_trails <- st_read("~/../../capstone/milkweedmod/data/CA_transportation/Trans_TrailSegment.shp")

# ------- tidy trails & roads data -----------------
trails_roads_reprojected <- trails_and_roads %>% 
  st_transform(crs = st_crs(lpnf_boundary_south)) %>% # reproject CRS to EPSG 4326
  st_zm() %>%  # remove z-dimension
  janitor::clean_names() # tidy up column names

# st_crs(usgs_trails) # EPSG 4269

usgs_trails_reprojected <- usgs_trails %>% 
  st_transform(crs = st_crs(lpnf_boundary_south)) %>% 
  janitor::clean_names() %>% 
  dplyr::mutate(trail = 1) %>%  # add column of 1s for plotting
  dplyr::select(trail) # keep just this column for plotting

# ---- make subset for california state parks trails & roads data  ----
forest_watch_trails <- trails_roads_reprojected %>% 
  filter(type == "Trail") %>% # keep only Trails
  dplyr::select(type, geometry) %>%  # select relevant columns
  dplyr::mutate(trail = 1) # adding column of 1s for plotting

```

Crop to LPNF Southern portion & Plot to compare

```{r}
# crop LPNF Forest Watch trails data ----
forest_trails_south <- forest_watch_trails %>% 
  st_intersection(lpnf_boundary_south) 

# crop USGS trails data ----
usgs_trails_south <- usgs_trails_reprojected %>% 
  st_intersection(lpnf_boundary_south)


# plot to compare
#plot(forest_trails_south)
#plot(usgs_trails_south)

# plot on top of each other ----

ggplot() +
  geom_sf(data = usgs_trails_south, color = "blue") +
  geom_sf(data = forest_trails_south, color = "green", alpha = 0.5) +
  geom_sf(data = lpnf_boundary_south, color = "black", linewidth = 1, fill = "transparent") +
  theme_bw()

```



Perform anti-join to see if they line up (wouldn't want to have copies of the same road, as that would potentially double the distance calculation time)
```{r}
# return rows from x without a match in y
# trail_overlap_check <- st_join(x = cap_trails_south, y = usgs_trails_south,
#                                join = st_sym_difference)

# stopped because it was taking forever to run (over 15 minutes)
```

Full join using st_union within st_join

```{r}
joined_trails <- st_join(x = forest_trails_south,
                         y = usgs_trails_south,
                         join = st_union)

```

This took over 28 minutes to run, so I stopped it because I needed to move on and do other work.

Decision point: 
- keep green (forest watch) trails data for South, use USGS data for North, do the same with the roads data


## Roads 
```{r}
# make Forest Watch roads data subset ----
forest_watch_roads <- trails_roads_reprojected %>% 
  filter(type == "Road") %>% # keep only Trails
  dplyr::select(type, geometry) %>%  # select relevant columns
  dplyr::mutate(trail = 1) # adding column of 1s for plotting


# ----- Read in USGS Roads Data ----------------
# (there are 5 tiles... I'll read 1 in at a time and plot because these files are rather large) 
# because these files are large, it may take a while to read each one in
usgs_roads_0 <- st_read("~/../../capstone/milkweedmod/data/CA_transportation/Trans_RoadSegment_0.shp")
usgs_roads_1 <- st_read("~/../../capstone/milkweedmod/data/CA_transportation/Trans_RoadSegment_1.shp")
# usgs_roads_2 <- st_read("~/../../capstone/milkweedmod/data/CA_transportation/Trans_RoadSegment_2.shp")
# usgs_roads_3 <- st_read("~/../../capstone/milkweedmod/data/CA_transportation/Trans_RoadSegment_3.shp")
# usgs_roads_4 <- st_read("~/../../capstone/milkweedmod/data/CA_transportation/Trans_RoadSegment_4.shp")

# Plan: reproject and crop to Northern extent, then plot

# ---------- reproject & tidy ---------------------------
usgs_roads_0_tidy <- usgs_roads_0 %>% 
  st_transform(crs = st_crs(lpnf_boundary_north)) %>% 
  janitor::clean_names() %>% 
  dplyr::mutate(road = 1) %>%  # add column of 1s for plotting
  dplyr::select(road) # keep just this column (and geometries) for plotting

usgs_roads_1_tidy <- usgs_roads_1 %>% 
  st_transform(crs = st_crs(lpnf_boundary_north)) %>% 
  janitor::clean_names() %>% 
  dplyr::mutate(road = 1) %>%  # add column of 1s for plotting
  dplyr::select(road) # keep just this column (and geometries) for plotting

usgs_roads_2_tidy <- usgs_roads_2 %>%
  st_transform(crs = st_crs(lpnf_boundary_north)) %>%
  janitor::clean_names() %>%
  dplyr::mutate(road = 1) %>%  # add column of 1s for plotting
  dplyr::select(road) # keep just this column (and geometries) for plotting

usgs_roads_3_tidy <- usgs_roads_3 %>%
  st_transform(crs = st_crs(lpnf_boundary_north)) %>%
  janitor::clean_names() %>%
  dplyr::mutate(road = 1) %>%  # add column of 1s for plotting
  dplyr::select(road) # keep just this column (and geometries) for plotting

usgs_roads_4_tidy <- usgs_roads_4 %>%
  st_transform(crs = st_crs(lpnf_boundary_north)) %>%
  janitor::clean_names() %>%
  dplyr::mutate(road = 1) %>%  # add column of 1s for plotting
  dplyr::select(road) # keep just this column (and geometries) for plotting

# ------------ crop to northern region of LPNF --------------------------

usgs_roads_0_crop <- usgs_roads_0_tidy %>% 
  st_intersection(lpnf_boundary_north)

usgs_roads_1_crop <- usgs_roads_1_tidy %>% 
  st_intersection(lpnf_boundary_north)

# these roads did not share any geometries with the forest
# usgs_roads_2_crop <- usgs_roads_2_tidy %>%
#   st_crop(lpnf_boundary_north)
# 
# usgs_roads_3_crop <- usgs_roads_3_tidy %>%
#   st_crop(lpnf_boundary_north)
# 
# usgs_roads_4_crop <- usgs_roads_4_tidy %>%
#   st_crop(lpnf_boundary_north)

# ------------ plot --------------------------
# plot to see if this tile is in the north
#plot(usgs_roads_0_crop)
#plot(usgs_roads_1_crop)

ggplot() +
  geom_sf(data = usgs_roads_0_crop, color = "yellow") +
  geom_sf(data = usgs_roads_1_crop, color = "red") +
  geom_sf(data = lpnf_boundary_north,color = "blue", fill = "transparent", size = 8) +
  theme_classic()


# ---------- combine road files 0 and 1 -----------
usgs_roads_north <- rbind(usgs_roads_0_crop, usgs_roads_1_crop)


# ------ Plot to check ------------
ggplot() +
  geom_sf(data = lpnf_boundary_north, color = "seagreen",
          fill = "transparent", linewidth = 1) +
  geom_sf(data = usgs_roads_north, color = "black", linewidth = 0.5) +
  theme_bw()
```


## USGS trails North

```{r}

usgs_trails_north <- usgs_trails_reprojected %>% 
  st_intersection(lpnf_boundary_north)

ggplot() +
  geom_sf(data = lpnf_boundary_north, color = "seagreen",
          fill = "transparent", linewidth = 1) +
  geom_sf(data = usgs_trails_north, color = "black", linewidth = 0.5) +
  theme_bw()

st_write(usgs_trails_north, "~/../../capstone/milkweedmod/data/clean_data/trails_roads/", "usgs_trails_south.shp")

```



```{r}
# ============ repeat steps to compare USGS data in South to Forest Watch data ============

# ----------- Crop to South --------------------

# yields 2310 observations
usgs_roads_0_south <- usgs_roads_0_tidy %>% 
  st_intersection(lpnf_boundary_south)

# yields 3204 observations
usgs_roads_1_south <- usgs_roads_1_tidy %>% 
  st_intersection(lpnf_boundary_south)

# this yields 0 observations of 2 variables
# usgs_roads_2_south <- usgs_roads_2_tidy %>%
#   st_intersection(lpnf_boundary_south)

# yields 16 observations
usgs_roads_3_south <- usgs_roads_3_tidy %>%
  st_intersection(lpnf_boundary_south)

# yields 7 observations
usgs_roads_4_south <- usgs_roads_4_tidy %>%
  st_intersection(lpnf_boundary_south)


# ---------- Plot -----------
ggplot() +
  geom_sf(data = usgs_roads_0_south, color = "yellow", linewidth = 1) +
  geom_sf(data = usgs_roads_1_south, color = "red", linewidth = 1) +
#  geom_sf(data = usgs_roads_2_south, color = "lightblue") +
  geom_sf(data = usgs_roads_3_south, color = "green", linewidth = 1) +
  geom_sf(data = usgs_roads_4_south, color = "lightblue", linewidth = 1) +
  geom_sf(data = lpnf_boundary_south,color = "black", fill = "transparent", linewidth = 1) +
  theme_classic()


# ----- Combine road sections ------------

usgs_roads_south <- rbind(usgs_roads_0_south, usgs_roads_1_south,
                         # usgs_roads_2_south,
                          usgs_roads_3_south, usgs_roads_4_south)


# ------ Plot to check ------------
ggplot() +
  geom_sf(data = lpnf_boundary_south, color = "seagreen",
          fill = "transparent", linewidth = 1) +
  geom_sf(data = usgs_roads_south, color = "black", linewidth = 0.5) +
  theme_bw()
```


## Compare USGS vs. Forest Watch Roads Data in South

```{r}
# making subset of roads data ----
forest_watch_roads <- trails_roads_reprojected %>% 
  filter(type == "Road") %>% # keep only Trails
  dplyr::select(type, geometry) %>%  # select relevant columns
  dplyr::mutate(road = 1) # adding column of 1s for plotting

# crop forest watch roads to southern border ----
forest_roads_south <- forest_watch_roads %>% 
  st_intersection(lpnf_boundary_south)



```


```{r}
# add data_source column for plotting -----
# roads -------
forest_roads_south <- forest_roads_south %>% 
  mutate(data_source = "Forest Watch (2023)")

usgs_roads_south <- usgs_roads_south %>% 
  mutate(data_source = "USGS (2024)")

# trails ------

forest_trails_south <- forest_trails_south %>% 
  mutate(data_source = "Forest Watch (2023)")
  
usgs_trails_south <- usgs_trails_south %>% 
  mutate(data_source = "USGS (2024)")



# ------ Plot to check ------------
ggplot() +
  geom_sf(data = lpnf_boundary_south, color = "black",
          fill = "transparent", linewidth = 1) +
  geom_sf(data = usgs_roads_south, aes(color = data_source), alpha = 0.7, linewidth = 0.5) +
  geom_sf(data = forest_roads_south, aes(color = data_source), alpha = 0.5, linewidth = 0.5) + 
  scale_color_manual(values = c("green", "blue")
                     # values = c("USGS" = "blue", "Forest Watch" = "green")
                     , labels = c("Forest Watch", "USGS"),
                     aesthetics = c("fill", "color"),
                     ) +
  # geom_sf(data = usgs_trails_south, color = "red", alpha = 0.7) +
  # geom_sf(data = forest_trails_south, color = "yellow", alpha = 0.5) +
  theme_bw() +
  labs(title = "Road Data Comparison",
       #subtitle = "USGS (blue), Forest Watch (green), both (turquoise)"
       legend = "Data Source"
       )

ggplot() +
  geom_sf(data = lpnf_boundary_south, color = "black",
          fill = "transparent", linewidth = 1) +
  # geom_sf(data = usgs_roads_south, color = "blue", alpha = 0.7, linewidth = 0.5) +
  # geom_sf(data = forest_roads_south, color = "green", alpha = 0.5, linewidth = 0.5) + 
  geom_sf(data = usgs_trails_south, color = "blue", alpha = 0.7) +
  geom_sf(data = forest_trails_south, color = "green", alpha = 0.5) +
  theme_bw() +
  labs(title = "Trail Data Comparison",
       subtitle = "USGS (blue), Forest Watch (green), both (turquoise)",
       legend = "Data Source")


```


Publication date of USGS data is February 15th 2024