---
title: "SBBG centroids + Bioclim"
format: html
---

### Packages

Wallace uses the following R packages that must be installed and loaded
before starting.

```{r}
library(spocc)
library(spThin)
library(dismo)
library(sf)
library(ENMeval)
library(wallace)
library(tidyverse)
library(sf)
```

```{r}
milkweed_path <- here("~/../../capstone/milkweedmod/data/milkweed_polygon_data/")
milkweed_data_raw <- st_read(milkweed_path)

# remove "No" observations
milkweed_presence <- milkweed_data_raw |> 
  janitor::clean_names() |> 
  filter(milkweed_p != "no")  %>%
  st_transform("EPSG:4326") %>% 
  st_centroid()

milkweed_points <- milkweed_presence %>%
  st_coordinates() 

milkweed_prep <- bind_cols(milkweed_presence, milkweed_points) %>%
  rename(longitude = X,
         latitude = Y) %>%
  mutate(scientific_name = "all milkweed")
  select(longitude, latitude, scientific_name) %>%
  st_drop_geometry()
```

## Analysis

### Obtain Occurrence Data

You searched the gbif database for *Asclepias californica*, limited to
100 records. You decided to remove occurrences without uncertainty
information? FALSE

```{r}
# Query selected database for occurrence records
# queryDb_Ac <- occs_queryDb(
#   spNames = "Asclepias californica", 
#   occDb = "gbif", 
#   occNum = 100,
#   RmUncertain = FALSE)
 occs_Ac <- milkweed_prep
```

### Obtain environmental data

Using WorldClim (<http://www.worldclim.org/>) bioclimatic dataset at
resolution of 0.5 arcmin.

```{r}
# Download environmental data 
envs_Ac <- envs_worldclim(
  bcRes = 0.5, # resolution 30arc seconds
  bcSel = c('bio01', 'bio02', 'bio03', 'bio04', 'bio05', 'bio06', 'bio07', 'bio08', 'bio09', 'bio10', 'bio11', 'bio12', 'bio13', 'bio14', 'bio15', 'bio16', 'bio17', 'bio18', 'bio19'), # select all bioclim vars
  mapCntr = c(-119.256, 34.791), # Mandatory for 30 arcsec resolution - might need to adjust  
  doBrick = FALSE)
occs_geom_Ac <- occs_Ac[c("longitude", "latitude")]
occs_vals_Ac <- as.data.frame(raster::extract(envs_Ac, occs_geom_Ac, cellnumbers = TRUE))

# Remove duplicated same cell values
# occs_Ac <- occs_Ac[!duplicated(occs_vals_Ac[, 1]), ]
# occs_vals_Ac <- occs_vals_Ac[!duplicated(occs_vals_Ac[, 1]), -1]

# # remove occurrence records with NA environmental values
# occs_Ac <- occs_Ac[!(rowSums(is.na(occs_vals_Ac)) >= 1), ]
# 
# # also remove variable value rows with NA environmental values
# occs_vals_Ac <- na.omit(occs_vals_Ac)

# add columns for env variable values for each occurrence record
occs_Ac <- cbind(occs_Ac, occs_vals_Ac)
```

### Process Occurrence Data

Thinning the occurrences to 0.25 km

```{r}
# Thin occurrences 
occs_Ac <- poccs_thinOccs(
  occs = occs_Ac, 
  thinDist = 0.1) # adjust this value if needed
```

### Process environmental data

Sampling of 1000 background points and corresponding environmental data
using a “minimum convex polygon” method with a 0.25 degree buffer.

```{r}
# Generate background extent 
bgExt_Ac <- penvs_bgExtent(
  occs = occs_Ac,
  bgSel = "minimum convex polygon",
  bgBuf = 0.25)
# Mask environmental data to provided extent
bgMask_Ac <- penvs_bgMask(
  occs = occs_Ac,
  envs = envs_Ac,
  bgExt = bgExt_Ac)
# Sample background points from the provided area
bgSample_Ac <- penvs_bgSample(
  occs = occs_Ac,
  bgMask =  bgMask_Ac,
  bgPtsNum = 1000)
# Extract values of environmental layers for each background point
bgEnvsVals_Ac <- as.data.frame(raster::extract(bgMask_Ac,  bgSample_Ac))
##Add extracted values to background points table
bgEnvsVals_Ac <- cbind(scientific_name = paste0("bg_", "Asclepias californica"), bgSample_Ac,
                            occID = NA, year = NA, institution_code = NA, country = NA,
                            state_province = NA, locality = NA, elevation = NA,
                            record_type = NA, bgEnvsVals_Ac)
```

### Partition occurrence data

Partition occurrences and background points for model training and
validation using jackknife, a non-spatial partition method.

```{r}
# R code to get partitioned data
groups_Ac <- part_partitionOccs(
  occs = occs_Ac ,
  bg =  bgSample_Ac, 
  method = "jack", # can also change this - function see documentation
  kfolds = 45) 
```

### Partition occurrence data

Partition occurrences and background points for model training and
validation using “jackknife”, a spatial partition method with an
aggregation factor of 2.

```{r}
# R code to get partitioned data
groups_Ac <- part_partitionOccs(
  occs = occs_Ac ,
  bg =  bgSample_Ac, 
  method = "jack",
  bgMask = bgMask_Ac,
  aggFact = 2) 
```

### Build and Evaluate Niche Model

Generating a species distribution model using the maxnet algorithm as
implemented in ENMeval V2.0 (with clamping = FALSE). For tuning using L,
LQ, H, LQH, LQHP feature classes and regularization multipliers in the
1, 2 range increasing by 1. Not using any categorical predictor
variables.

```{r}
# Run maxent model for the selected species
model_Ac <- model_maxent(
  occs = occs_Ac,
  bg = bgEnvsVals_Ac,
  user.grp = groups_Ac, 
  bgMsk = bgMask_Ac,
  rms = c(1, 2), 
  rmsStep =  1,
  fcs = c('L', 'LQ', 'H', 'LQH', 'LQHP'),
  clampSel = FALSE,
  algMaxent = "maxnet",
  parallel = FALSE,
  numCores = 7)
```

### Visualize

Generate a map of the maxnet generated model with no threshold

```{r}
# Select current model and obtain raster prediction
m_Ac <- model_Ac@models[["fc.L_rm.1"]] # change this for different models
predSel_Ac <- predictMaxnet(m_Ac, bgMask_Ac,
                                          type = "cloglog", 
                                          clamp = FALSE)
#Get values of prediction
mapPredVals_Ac <- getRasterVals(predSel_Ac, "cloglog")

#Define colors and legend  
rasCols <- c("#2c7bb6", "#abd9e9", "#ffffbf", "#fdae61", "#d7191c")
legendPal <- colorNumeric(rev(rasCols), mapPredVals_Ac, na.color = 'transparent')
rasPal <- colorNumeric(rasCols, mapPredVals_Ac, na.color = 'transparent')

#Generate map
m <- leaflet() %>% addProviderTiles(providers$Esri.WorldTopoMap) 
m  %>%
  leaflet::addLegend("bottomright", pal = legendPal,
            title = "Predicted Suitability<br>(Training)",
            values = mapPredVals_Ac, layerId = "train",
            labFormat = reverseLabel(2, reverse_order = TRUE)) %>% 
  #add occurrence data
  addCircleMarkers(data = occs_Ac, lat = ~latitude, lng = ~longitude,
                   radius = 5, color = 'red', fill = TRUE, fillColor = "red",
                   fillOpacity = 0.2, weight = 2, popup = ~pop) %>% 
  ##Add model prediction
  addRasterImage(predSel_Ac, colors = rasPal, opacity = 0.7,
                 group = 'vis', layerId = 'mapPred', method = "ngb") %>%
 ##add background polygons
  addPolygons(data = bgExt_Ac,fill = FALSE,
              weight = 4, color = "blue", group = 'proj')
```

